SELECT A.BILL_CYCLE_ID, A.CONTRACT_NUM, B.OPT_OPPORNTY_URLID, A.BILL_PLAN_ID, A.BILL_TO_CUST_ID, C.NAME1, A.ADDR_SEQ_NUM_BILL, A.CNTCT_SEQ_BILL, D.ADDRESS1, D.ADDRESS2, D.ADDRESS3, D.ADDRESS4, D.CITY, D.STATE, D.POSTAL, E.CONTACT_ID, F.NAME1, F.TITLE, F.EMAILID, G.PRICING_STRUCTURE, CASE WHEN  G.PRICING_STRUCTURE = 'RATE' THEN  I.NET_AMOUNT ELSE   H.AMOUNT END CASE,C.SETID,C.CUST_ID,F.SETID,F.CONTACT_ID,TO_CHAR(F.EFFDT,'YYYY-MM-DD'), EE.OPT_SFDC_ID AS CUST_CRS_REF,FF.OPT_SFDC_ID AS CONT_CRS_REF 
  FROM PS_CA_BILL_PLAN A, PS_OPT_CA_ADLN_TBL B, PS_CUSTOMER C, PS_CUST_ADDRESS D, (PS_CONTACT_CUST E LEFT OUTER JOIN  PS_CONTACT F ON  E.SETID = F.SETID AND E.CONTACT_ID = F.CONTACT_ID ), PS_CA_DETAIL G, (PS_CA_BP_EVENTS H LEFT OUTER JOIN  PS_CA_BP_XREF I ON  H.CONTRACT_NUM = I.CONTRACT_NUM AND H.BILL_PLAN_ID = I.BILL_PLAN_ID AND H.EVENT_OCCURRENCE = I.EVENT_OCCURRENCE ) , PS_OPT_CUST_CRSREF EE, PS_OPT_CONT_CRSREF FF
  WHERE ( A.BILL_CYCLE_ID = 'CES' 
     AND A.CONTRACT_NUM like '%2225' and A.CONTRACT_NUM = B.CONTRACT_NUM 
     AND A.BILL_TO_CUST_ID = C.CUST_ID 
     AND D.EFFDT = 
        (SELECT MAX(D_ED.EFFDT) FROM PS_CUST_ADDRESS D_ED 
        WHERE D.SETID = D_ED.SETID 
          AND D.CUST_ID = D_ED.CUST_ID 
          AND D.ADDRESS_SEQ_NUM = D_ED.ADDRESS_SEQ_NUM 
          AND D_ED.EFFDT <= SYSDATE) 
     AND A.BILL_TO_CUST_ID = D.CUST_ID 
     AND A.ADDR_SEQ_NUM_BILL = D.ADDRESS_SEQ_NUM 
     AND E.EFFDT = 
        (SELECT MAX(E_ED.EFFDT) FROM PS_CONTACT_CUST E_ED 
        WHERE E.SETID = E_ED.SETID 
          AND E.CONTACT_ID = E_ED.CONTACT_ID
          AND E.CUST_ID = E_ED.CUST_ID            
          AND E_ED.EFFDT <= SYSDATE) 
     AND A.BILL_TO_CUST_ID = E.CUST_ID 
     AND A.ADDR_SEQ_NUM_BILL = E.ADDRESS_SEQ_NUM 
     AND A.CNTCT_SEQ_BILL = E.CNTCT_SEQ_NUM 
     AND F.EFFDT = 
        (SELECT MAX(F_ED.EFFDT) FROM PS_CONTACT F_ED 
        WHERE F.SETID = F_ED.SETID 
          AND F.CONTACT_ID = F_ED.CONTACT_ID 
          AND F_ED.EFFDT <= E.EFFDT) 
     AND A.CONTRACT_NUM = G.CONTRACT_NUM 
     AND A.BILL_PLAN_ID = G.BILL_PLAN_ID 

     AND G.CONTRACT_LINE_NUM = B.CONTRACT_LINE_NUM

     AND A.CONTRACT_NUM = H.CONTRACT_NUM 
     AND A.BILL_PLAN_ID = H.BILL_PLAN_ID 
     
     AND A.BILL_TO_CUST_ID = EE.CUST_ID
         AND A.BILL_TO_CUST_ID = E.CUST_ID
         AND A.CNTCT_SEQ_BILL = E.CNTCT_SEQ_NUM
         AND E.CONTACT_ID = FF.CONTACT_ID) 
  ORDER BY 1, 2, 4 
