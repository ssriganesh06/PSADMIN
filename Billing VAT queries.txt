-- VAT fields at bill level and base currency calculation

-- 09.04.40 ...........(FS_VATCALC.UpdBsAmt.Step01) (SQL)
UPDATE PS_VAT_CALC_TAO4 SET VAT_TX_AMT_BSE_TMP = TRUNC(((((VAT_TRANS_AMT) / 
(RATE_DIV))) * (RATE_MULT)),5), VAT_BASIS_BSE_TMP = TRUNC(((((VAT_BASIS_AMT) 
/ (RATE_DIV))) * (RATE_MULT)),5), VAT_AMT_BSE_TMP = TRUNC(((((VAT_CALC_AMT) / 
(RATE_DIV))) * (RATE_MULT)),5), VAT_RCVRY_BSE_TMP = TRUNC(((((VAT_RCVRY_AMT) 
/ (RATE_DIV))) * (RATE_MULT)),5), VAT_D_ADJ_BSE_TMP = 
TRUNC(((((VAT_DSCNT_ADJ) / (RATE_DIV))) * (RATE_MULT)),5), VAT_D_RCV_BSE_TMP 
= TRUNC(((((VAT_DSCNT_RCVRY) / (RATE_DIV))) * (RATE_MULT)),5), 
VAT_REBATE_BSE_TMP = TRUNC(((((VAT_REBATE_AMT) / (RATE_DIV))) * 
(RATE_MULT)),5) WHERE PROCESS_INSTANCE = 16364

-- 09.04.41 .........(BIIVC000.VATEXTYP.Step10) (SQL)
UPDATE PS_BI_FLINE_TAO4 SET TAX_CD_VAT_PCT = :1, VAT_AMT = :2, VAT_BASIS_AMT 
= :3, VAT_AMT_BSE = :4, VAT_BASIS_AMT_BSE = :5, VAT_TRANS_AMT = :6, 
VAT_TRANS_AMT_BSE = :7 , TAX_CD_VAT_RVC_PCT = :8, VAT_AMT_RVC = :9, 
VAT_AMT_RVC_BSE = :10 WHERE BUSINESS_UNIT = :11 AND INVOICE = :12 AND 
LINE_SEQ_NUM = :13 AND LINE_TYPE NOT IN ('DEP', 'DAPP', 'DREF', 'DRFF') AND 
'E' = :14


-- 09.04.44 ....(BIIVC000.UPDBITBL.Step04) (SQL)
UPDATE PS_BI_LINE SET (MAX_TAX_FLG, EXD_TAX_AMT, EXD_TAX_AMT_BSE, 
EXD_TAX_AMT_RPT, STX_TAX_AMT, STX_TAX_AMT_BSE, STX_TAX_AMT_RPT, 
IST_DISTRIB_STATUS, TAX_CD_VAT_PCT, VAT_AMT, VAT_BASIS_AMT, VAT_AMT_BSE, 
VAT_BASIS_AMT_BSE, VAT_TRANS_AMT, VAT_TRANS_AMT_BSE, VAT_DISTRIB_STATUS, 
VAT_DST_ACCT_TYPE, TAX_CD_VAT_RVC_PCT, VAT_AMT_RVC, VAT_AMT_RVC_BSE, 
TAX_VAT_FLG, INVOICE_LINE, FINAL_TAX_FLG, TAX_AMT, TAX_PCT, TAX_AMT_BSE, 
UNIT_AMT, NET_EXTENDED_AMT , NET_EXTENDED_BSE , GROSS_EXTENDED_AMT , 
GROSS_EXTENDED_BSE , TOT_LINE_DST_AMT , TOT_LINE_DST_BSE , TOT_LINE_DFR_AMT , 
TOT_LINE_DFR_BSE, ERROR_STATUS_BI, LAST_MAINT_OPRID, LAST_UPDATE_DTTM)=( 
SELECT MAX_TAX_FLG , EXD_TAX_AMT , EXD_TAX_AMT_BSE , EXD_TAX_AMT_RPT , 
STX_TAX_AMT , STX_TAX_AMT_BSE , STX_TAX_AMT_RPT , IST_DISTRIB_STATUS , 
TAX_CD_VAT_PCT , VAT_AMT , VAT_BASIS_AMT , VAT_AMT_BSE , VAT_BASIS_AMT_BSE , 
VAT_TRANS_AMT , VAT_TRANS_AMT_BSE , VAT_DISTRIB_STATUS , VAT_DST_ACCT_TYPE , 
TAX_CD_VAT_RVC_PCT , VAT_AMT_RVC , VAT_AMT_RVC_BSE , TAX_VAT_FLG , 
INVOICE_LINE , FINAL_TAX_FLG , TAX_AMT , TAX_PCT , TAX_AMT_BSE , UNIT_AMT , 
NET_EXTENDED_AMT , NET_EXTENDED_BSE , GROSS_EXTENDED_AMT , GROSS_EXTENDED_BSE 
, TOT_LINE_DST_AMT , TOT_LINE_DST_BSE , TOT_LINE_DFR_AMT , TOT_LINE_DFR_BSE , 
ERROR_STATUS_BI , 'PSDEMO' , CAST(SYSTIMESTAMP AS TIMESTAMP) FROM 
PS_BI_FLINE_TAO4 D WHERE D.PROCESS_INSTANCE = 16364 AND D.BUSINESS_UNIT = 
PS_BI_LINE.BUSINESS_UNIT AND D.INVOICE = PS_BI_LINE.INVOICE AND 
D.LINE_SEQ_NUM = PS_BI_LINE.LINE_SEQ_NUM) WHERE (BUSINESS_UNIT, INVOICE, 
LINE_SEQ_NUM) IN ( SELECT D1.BUSINESS_UNIT , D1.INVOICE , D1.LINE_SEQ_NUM 
FROM PS_BI_FLINE_TAO4 D1 WHERE D1.PROCESS_INSTANCE = 16364)
/


-- VAT accounting entries

-- 08.57.06 ......(BIPRELD.VATTAX2.VATACCT) (SQL)
INSERT INTO PS_BI_ACCT_LN_STG (BUSINESS_UNIT, INVOICE, LINE_SEQ_NUM, 
ACCOUNTING_DT, ACCT_ENTRY_TYPE, DISC_SUR_LVL, DISC_SUR_ID, LINE_DST_SEQ_NUM, 
TAX_AUTHORITY_CD, DST_SEQ_NUM, PROCESS_INSTANCE, DISC_SUR_INDICATOR, 
CF_BAL_LINE_NUM, BUSINESS_UNIT_GL, LEDGER_GROUP, LEDGER, ACCOUNTING_PERIOD, 
FISCAL_YEAR, ACCOUNT, ALTACCT, DEPTID, OPERATING_UNIT, PRODUCT, FUND_CODE, 
CLASS_FLD, PROGRAM_CODE, BUDGET_REF, AFFILIATE, AFFILIATE_INTRA1, 
AFFILIATE_INTRA2, CHARTFIELD1, CHARTFIELD2, CHARTFIELD3, BUSINESS_UNIT_PC, 
PROJECT_ID, ACTIVITY_ID, RESOURCE_TYPE, RESOURCE_CATEGORY, RESOURCE_SUB_CAT, 
ANALYSIS_TYPE, STATISTICS_CODE, MONETARY_AMOUNT, STATISTIC_AMOUNT, 
OPEN_ITEM_KEY, JRNL_LN_REF, LINE_DESCR, USER1, USER2, USER3, USER4, USER5, 
JOURNAL_ID, JOURNAL_DATE, JOURNAL_LINE, BUDGET_DT, BUDGET_HDR_STATUS, 
BUDGET_LINE_STATUS, KK_TRAN_OVER_FLAG, KK_TRAN_OVER_OPRID, KK_TRAN_OVER_DTTM, 
GL_DISTRIB_STATUS, APPL_JRNL_ID, CURRENCY_CD, FOREIGN_CURRENCY, 
FOREIGN_AMOUNT, RT_TYPE, DOC_TYPE, DOC_SEQ_NBR, DOC_SEQ_DATE, RATE_MULT, 
RATE_DIV, FROM_ACCRUAL, ENTRY_EVENT, IU_ANCHOR_FLG, IU_SYS_TRAN_CD, 
IU_TRAN_CD, BI_PRELD_STAT, ERROR_STATUS_BI, CF_ACTION_FLG) SELECT 
HSTG.BUSINESS_UNIT, HSTG.INVOICE, LINE.LINE_SEQ_NUM, HSTG.ACCOUNTING_DT, 
'VT', 0, ' ', LINE.LINE_DST_SEQ_NUM, ' ', 0, HSTG.PROCESS_INSTANCE, ' ', 0, 
HSTG.BUSINESS_UNIT_GL, ' ', ' ', 0, 0, VAT_DST.ACCOUNT, VAT_DST.ALTACCT, 
VAT_DST.DEPTID, VAT_DST.OPERATING_UNIT, VAT_DST.PRODUCT, VAT_DST.FUND_CODE, 
VAT_DST.CLASS_FLD, VAT_DST.PROGRAM_CODE, VAT_DST.BUDGET_REF, 
VAT_DST.AFFILIATE, VAT_DST.AFFILIATE_INTRA1, VAT_DST.AFFILIATE_INTRA2, 
VAT_DST.CHARTFIELD1, VAT_DST.CHARTFIELD2, VAT_DST.CHARTFIELD3, ' ', 
VAT_DST.PROJECT_ID, ' ', ' ', ' ', ' ', ' ', ' ', LINE.VAT_AMT_BSE * -1, 0, ' 
', ' ', ' ', LINE.USER1, LINE.USER2, LINE.USER3, LINE.USER4, LINE.USER5, ' ', 
NULL, 0, NULL, ' ', ' ', ' ', ' ', NULL, ' ', ' ', HSTG.BASE_CURRENCY, 
HSTG.BI_CURRENCY_CD, LINE.VAT_AMT * -1, HSTG.CUR_RT_TYPE, HSTG.DOC_TYPE, 
HSTG.DOC_SEQ_NBR, HSTG.DOC_SEQ_DATE, HSTG.RATE_MULT, HSTG.RATE_DIV, 'N', 
HSTG.ENTRY_EVENT, ' ', ' ', ' ', HSTG.BI_PRELD_STAT, HSTG.ERROR_STATUS_BI, 
HSTG.CF_ACTION_FLG FROM PS_BI_ACCT_HDR_STG HSTG, PS_BI_LINE LINE, 
PS_VAT_ACCT_TBL VAT_DST, PS_BI_HDR_VAT VAT WHERE HSTG.PROCESS_INSTANCE = :1 
AND HSTG.BUSINESS_UNIT = :2 AND HSTG.INVOICE = :3 AND HSTG.BUSINESS_UNIT = 
LINE.BUSINESS_UNIT AND HSTG.INVOICE = LINE.INVOICE AND LINE.LINE_SEQ_NUM = :4 
AND LINE.VAT_AMT <> 0 AND HSTG.BUSINESS_UNIT = VAT.BUSINESS_UNIT AND 
HSTG.INVOICE = VAT.INVOICE AND VAT_DST.SETID = ( SELECT SETID FROM 
PS_SET_CNTRL_REC WHERE SETCNTRLVALUE = :5 AND RECNAME = 'VAT_ACCT_TBL') AND 
VAT_DST.TAX_CD = LINE.TAX_CD_VAT AND VAT_DST.VAT_DST_ACCT_TYPE = 
LINE.VAT_DST_ACCT_TYPE AND VAT_DST.VAT_TXN_TYPE_CD = LINE.VAT_TXN_TYPE_CD AND 
LINE.INVOICE NOT IN ( SELECT LSTG.INVOICE FROM PS_BI_ACCT_LN_STG LSTG WHERE 
LSTG.BUSINESS_UNIT = :6 AND LSTG.INVOICE = LINE.INVOICE AND LSTG.LINE_SEQ_NUM 
= LINE.LINE_SEQ_NUM AND LSTG.ACCT_ENTRY_TYPE = 'VT')


-- 08.57.06 ....(BIPRELD.INSLNTAX.TAXGST) (SQL)
INSERT INTO PS_BI_ACCT_LN_STG (BUSINESS_UNIT, INVOICE, LINE_SEQ_NUM, 
ACCOUNTING_DT, ACCT_ENTRY_TYPE, DISC_SUR_LVL, DISC_SUR_ID, LINE_DST_SEQ_NUM, 
TAX_AUTHORITY_CD, DST_SEQ_NUM, PROCESS_INSTANCE, DISC_SUR_INDICATOR, 
CF_BAL_LINE_NUM, BUSINESS_UNIT_GL, LEDGER_GROUP, LEDGER, ACCOUNTING_PERIOD, 
FISCAL_YEAR, ACCOUNT, ALTACCT, DEPTID, OPERATING_UNIT, PRODUCT, FUND_CODE, 
CLASS_FLD, PROGRAM_CODE, BUDGET_REF, AFFILIATE, AFFILIATE_INTRA1, 
AFFILIATE_INTRA2, CHARTFIELD1, CHARTFIELD2, CHARTFIELD3, BUSINESS_UNIT_PC, 
PROJECT_ID, ACTIVITY_ID, RESOURCE_TYPE, RESOURCE_CATEGORY, RESOURCE_SUB_CAT, 
ANALYSIS_TYPE, STATISTICS_CODE, MONETARY_AMOUNT, STATISTIC_AMOUNT, 
OPEN_ITEM_KEY, JRNL_LN_REF, LINE_DESCR, USER1, USER2, USER3, USER4, USER5, 
JOURNAL_ID, JOURNAL_DATE, JOURNAL_LINE, BUDGET_DT, BUDGET_HDR_STATUS, 
BUDGET_LINE_STATUS, KK_TRAN_OVER_FLAG, KK_TRAN_OVER_OPRID, KK_TRAN_OVER_DTTM, 
GL_DISTRIB_STATUS, APPL_JRNL_ID, CURRENCY_CD, FOREIGN_CURRENCY, 
FOREIGN_AMOUNT, RT_TYPE, DOC_TYPE, DOC_SEQ_NBR, DOC_SEQ_DATE, RATE_MULT, 
RATE_DIV, FROM_ACCRUAL, ENTRY_EVENT, IU_ANCHOR_FLG, IU_SYS_TRAN_CD, 
IU_TRAN_CD, BI_PRELD_STAT, ERROR_STATUS_BI, CF_ACTION_FLG) SELECT 
HSTG.BUSINESS_UNIT, HSTG.INVOICE, TAX.LINE_SEQ_NUM, HSTG.ACCOUNTING_DT, 'TX', 
0, ' ', 0, TAX.TAX_AUTHORITY_CD, 0, HSTG.PROCESS_INSTANCE, ' ', 0, 
HSTG.BUSINESS_UNIT_GL, ' ', ' ', 0, 0, DST.ACCOUNT, DST.ALTACCT, DST.DEPTID, 
DST.OPERATING_UNIT, DST.PRODUCT, DST.FUND_CODE, DST.CLASS_FLD, 
DST.PROGRAM_CODE, DST.BUDGET_REF, DST.AFFILIATE, DST.AFFILIATE_INTRA1, 
DST.AFFILIATE_INTRA2, DST.CHARTFIELD1, DST.CHARTFIELD2, DST.CHARTFIELD3, 
DST.BUSINESS_UNIT_PC, DST.PROJECT_ID, DST.ACTIVITY_ID, DST.RESOURCE_TYPE, 
DST.RESOURCE_CATEGORY, DST.RESOURCE_SUB_CAT, DST.ANALYSIS_TYPE, 
DST.STATISTICS_CODE, ((TAX.TAX_AMT_BSE) * ( -1)), 0, ' ', ' ', ' ', ' ', ' ', 
' ', ' ', ' ', ' ', NULL, 0, NULL, ' ', ' ', ' ', ' ', NULL, ' ', ' ', 
HSTG.BASE_CURRENCY, HSTG.BI_CURRENCY_CD, ((TAX.TAX_AMT) * ( -1)), 
HSTG.CUR_RT_TYPE, HSTG.DOC_TYPE, HSTG.DOC_SEQ_NBR, HSTG.DOC_SEQ_DATE, 
HSTG.RATE_MULT, HSTG.RATE_DIV, 'N', HSTG.ENTRY_EVENT, ' ', ' ', ' ', 
HSTG.BI_PRELD_STAT, HSTG.ERROR_STATUS_BI, HSTG.CF_ACTION_FLG FROM 
PS_BI_ACCT_HDR_STG HSTG, PS_BI_LINE_TAX_DTL TAX, PS_DST_CODE_TBL DST WHERE 
HSTG.PROCESS_INSTANCE = 16369 AND HSTG.BUSINESS_UNIT = 'DEU01' AND 
HSTG.BUSINESS_UNIT = TAX.BUSINESS_UNIT AND HSTG.INVOICE = TAX.INVOICE AND 
DST.SETID = ( SELECT SETID FROM PS_SET_CNTRL_REC WHERE SETCNTRLVALUE = 
'DEU01' AND RECNAME = 'DST_CODE_TBL') AND DST.DST_ID = ' ' AND DST.EFFDT = ( 
SELECT MAX(EFFDT) FROM PS_DST_CODE_TBL WHERE SETID = DST.SETID AND DST_ID = 
DST.DST_ID AND EFFDT <= HSTG.INVOICE_DT) AND DST.EFF_STATUS = 'A' AND ' ' <> 
' ' AND TAX.TAX_AUTHORITY_CD = 'GST' AND 'N' <> 'N'

-- OPT_CA_ACCTG.BIPRELD.STEP02.Sql
UPDATE PS_BI_ACCT_LN_STG A  
  SET A.IU_ANCHOR_FLG = 'N', A.IU_SYS_TRAN_CD = 'BIIVC', A.IU_TRAN_CD = %Bind(BIIVC_IU_TRAN_CD), A.BI_PRELD_STAT = '1', A.CLASS_FLD = ( 
 SELECT E.OPT_PR_TAXGL_BU  
  FROM PS_BI_LINE C  
  ,PS_OPT_PROD_CRSREF E  
 WHERE A.PROCESS_INSTANCE = %Bind(PROCESS_INSTANCE)  
   AND A.ACCT_ENTRY_TYPE ='TX'  
   AND C.PRODUCT_ID = E.PRODUCT_ID  
   AND A.LINE_SEQ_NUM = C.LINE_SEQ_NUM  
   AND A.INVOICE = C.INVOICE  
   AND A.BUSINESS_UNIT = C.BUSINESS_UNIT  
   AND E.OPT_PR_TAXGL_OU <> ' '  
   AND E.OPT_PR_TAXGL_BU <> ' ') , A.OPERATING_UNIT = (  
 SELECT E.OPT_PR_TAXGL_OU  
  FROM PS_BI_LINE C  
  ,PS_OPT_PROD_CRSREF E  
 WHERE A.PROCESS_INSTANCE = %Bind(PROCESS_INSTANCE)  
   AND A.ACCT_ENTRY_TYPE ='TX'  
   AND C.PRODUCT_ID = E.PRODUCT_ID  
   AND A.LINE_SEQ_NUM = C.LINE_SEQ_NUM  
   AND A.INVOICE = C.INVOICE  
   AND A.BUSINESS_UNIT = C.BUSINESS_UNIT  
   AND E.OPT_PR_TAXGL_OU <> ' '  
   AND E.OPT_PR_TAXGL_BU <> ' ')  
 WHERE EXISTS (  
 SELECT 'X'  
  FROM PS_BI_LINE C  
  ,PS_OPT_PROD_CRSREF E  
 WHERE A.PROCESS_INSTANCE = %Bind(PROCESS_INSTANCE)  
   AND A.ACCT_ENTRY_TYPE ='TX'  
   AND C.PRODUCT_ID = E.PRODUCT_ID  
   AND A.LINE_SEQ_NUM = C.LINE_SEQ_NUM  
   AND A.INVOICE = C.INVOICE  
   AND A.BUSINESS_UNIT = C.BUSINESS_UNIT  
   AND E.OPT_PR_TAXGL_OU <> ' '  
   AND E.OPT_PR_TAXGL_BU <> ' ')

  
-- OPT_CA_ACCTG.BIPRELD.STEP03.Sql   
   UPDATE PS_BI_ACCT_LN_STG A 
     SET A.IU_ANCHOR_FLG = 'Y' 
    WHERE A.PROCESS_INSTANCE =%Bind(PROCESS_INSTANCE) 
      AND EXISTS ( 
    SELECT 'X' 
     FROM PS_BI_ACCT_LN_STG B 
    WHERE A.BUSINESS_UNIT = B.BUSINESS_UNIT 
      AND A.INVOICE = B.INVOICE 
      AND A.LINE_SEQ_NUM = B.LINE_SEQ_NUM 
      AND A.ACCOUNTING_DT = B.ACCOUNTING_DT 
      AND A.DISC_SUR_LVL = B.DISC_SUR_LVL 
      AND A.DISC_SUR_ID = B.DISC_SUR_ID 
      AND A.ACCT_ENTRY_TYPE = 'AR' 
      AND B.ACCT_ENTRY_TYPE = 'TX' 
      AND A.LINE_DST_SEQ_NUM = B.LINE_DST_SEQ_NUM 
   AND A.CLASS_FLD <> B.CLASS_FLD )
   
   -- OPT_CA_ACCTG.BIPRELD.STEP04.Sql   
   UPDATE PS_BI_ACCT_LN_STG A 
     SET A.IU_ANCHOR_FLG = 'Y' 
    WHERE A.PROCESS_INSTANCE =%Bind(PROCESS_INSTANCE) 
      AND EXISTS ( 
    SELECT 'X' 
     FROM PS_BI_ACCT_LN_STG B 
    WHERE A.BUSINESS_UNIT = B.BUSINESS_UNIT 
      AND A.INVOICE = B.INVOICE 
      AND A.LINE_SEQ_NUM = B.LINE_SEQ_NUM 
      AND A.ACCOUNTING_DT = B.ACCOUNTING_DT 
      AND A.DISC_SUR_LVL = B.DISC_SUR_LVL 
      AND A.DISC_SUR_ID = B.DISC_SUR_ID 
      AND A.ACCT_ENTRY_TYPE = 'AR' 
      AND B.ACCT_ENTRY_TYPE IN ('UAR','RR') 
      AND A.LINE_DST_SEQ_NUM = B.LINE_DST_SEQ_NUM 
      AND A.CLASS_FLD <> B.CLASS_FLD )

-- Update SQL
SQLExec("UPDATE PS_BI_FLINE_TAO4 SET VAT_DISTRIB_STATUS = 'N' , VAT_AMT = :1, VAT_AMT_BSE = :2, TAX_CD_VAT_PCT = :3, FINAL_TAX_FLG =:4, 
MAX_TAX_FLG =:5, LAST_MAINT_OPRID = :6, LAST_UPDATE_DTTM = CAST(SYSTIMESTAMP AS TIMESTAMP) , VAT_BASIS_AMT = :10 , VAT_BASIS_AMT_BSE = :11, 
VAT_TRANS_AMT = :12, VAT_TRANS_AMT_BSE = :13 WHERE BUSINESS_UNIT = :7 AND INVOICE = :8 AND LINE_SEQ_NUM = :9", 10, 10, 1, "N", "N", "JSIRISH", 
BI_TAX_AET.BUSINESS_UNIT, BI_TAX_AET.INVOICE, 1, 1000, 1000, 1000, 1000);